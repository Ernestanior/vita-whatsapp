# 实现计划：Vita AI

## 概述

本实现计划将 Vita AI 的设计转化为可执行的开发任务。任务按照 MVP 优先的原则组织，确保核心功能优先实现，每个任务都可以独立完成并集成到系统中。

## 任务

- [x] 1. 项目初始化和基础设施搭建
  - 创建 Next.js + TypeScript 项目
  - 配置 Vercel 部署
  - 设置 Supabase 项目和数据库
  - 配置环境变量管理（使用 zod 验证）
  - 设置 ESLint、Prettier、TypeScript 配置
  - _需求: 12.1, 12.3_

- [x] 2. 数据库 Schema 和 RLS 策略
  - [x] 2.1 创建数据库表
    - 执行 SQL 创建 users、health_profiles、food_records、subscriptions、usage_quotas 表
    - 创建必要的索引
    - 创建数据库函数（increment_usage、get_user_stats）
    - _需求: 4.1, 4.2, 7.1_
  
  - [x] 2.2 配置 Row Level Security
    - 为所有表启用 RLS
    - 创建用户数据访问策略
    - 测试 RLS 策略是否正确工作
    - _需求: 11.1, 11.2_

- [ ] 3. WhatsApp Webhook 集成
  - [x] 3.1 实现 Webhook Handler
    - 创建 /api/webhook 端点
    - 实现 Webhook 验证逻辑
    - 实现消息接收和解析
    - 实现媒体文件下载
    - _需求: 5.1, 5.3_
  
  - [ ]* 3.2 编写 Webhook Handler 单元测试
    - 测试 Webhook 验证
    - 测试消息解析
    - 测试错误处理
    - _需求: 5.1_

- [x] 4. 消息路由和处理
  - [x] 4.1 实现消息路由器
    - 创建 MessageRouter 类
    - 实现消息类型识别（图片/文本/交互式）
    - 实现语言检测
    - _需求: 5.2, 5.7, 15.2_
  
  - [x] 4.2 实现文本消息处理器
    - 创建 TextHandler 类
    - 实现命令识别（/start、/profile、/help、/stats）
    - 实现自然语言理解（用于更新画像）
    - _需求: 5.2, 4.5_

- [ ] 5. 用户健康画像管理
  - [x] 5.1 实现 ProfileManager 类
    - 创建用户画像初始化流程
    - 实现对话式信息收集
    - 实现画像数据验证
    - 实现 BMI 和每日卡路里计算（Mifflin-St Jeor 公式）
    - _需求: 4.1, 4.2, 4.3, 4.8_
  
  - [ ]* 5.2 编写健康指标计算的属性测试
    - **属性 5: 健康指标计算正确性**
    - **验证需求: 4.3, 4.8**
  
  - [ ]* 5.3 编写输入验证的属性测试
    - **属性 6: 输入验证边界**
    - **验证需求: 4.2**

- [ ] 6. Checkpoint - 确保基础设施和用户管理正常工作
  - 确保所有测试通过，如有问题请询问用户


- [x] 7. OpenAI Vision API 集成和食物识别
  - [x] 7.1 实现 ImageHandler 类
    - 创建图片下载和预处理逻辑
    - 实现图片压缩和优化（使用 sharp）
    - 实现图片 SHA256 哈希计算
    - _需求: 1.1, 1.2, 12.2_
  
  - [x] 7.2 实现 Prompt Engineering
    - 创建新加坡食物识别的系统 Prompt
    - 实现 buildFoodRecognitionPrompt 函数
    - 包含新加坡食物数据库示例
    - _需求: 1.2, 1.8, 2.1_
  
  - [x] 7.3 实现食物识别核心逻辑
    - 调用 OpenAI GPT-4o-mini Vision API
    - 解析 JSON 响应
    - 处理低置信度情况（< 60%）
    - 处理识别失败情况
    - _需求: 1.2, 1.3, 1.4, 1.5_
  
  - [ ]* 7.4 编写食物识别完整性的属性测试
    - **属性 1: 食物识别完整性**
    - **验证需求: 1.2, 1.3, 1.6**
  
  - [ ]* 7.5 编写响应时间的属性测试
    - **属性 2: 响应时间保证**
    - **验证需求: 1.1, 12.1**

- [x] 8. 红黄绿灯健康评价引擎
  - [x] 8.1 实现 RatingEngine 类
    - 实现 calculateDailyTarget 方法（基于用户画像）
    - 实现各项指标评估（卡路里、钠、脂肪、均衡性）
    - 实现评分计算逻辑
    - 实现建议生成逻辑
    - _需求: 3.1, 3.2, 3.3, 3.4_
  
  - [ ]* 8.2 编写健康评价完整性的属性测试
    - **属性 3: 健康评价完整性**
    - **验证需求: 3.1, 3.2, 3.3**
  
  - [ ]* 8.3 编写个性化评价一致性的属性测试
    - **属性 4: 个性化评价一致性**
    - **验证需求: 3.4**

- [x] 9. 缓存系统实现
  - [x] 9.1 集成 Upstash Redis
    - 配置 Upstash Redis 连接
    - 创建 CacheManager 类
    - 实现食物识别结果缓存
    - 实现用户画像缓存
    - _需求: 20.5_
  
  - [ ]* 9.2 编写缓存一致性的属性测试
    - **属性 10: 缓存一致性**
    - **验证需求: 20.5**

- [x] 10. 完整的食物识别流程集成
  - [x] 10.1 整合所有组件
    - 连接 ImageHandler、RatingEngine、CacheManager
    - 实现完整的识别 -> 评价 -> 保存 -> 响应流程
    - 实现快捷回复按钮（记录/修改/忽略）
    - _需求: 1.1, 1.2, 1.3, 3.1, 17.1, 17.2_
  
  - [ ]* 10.2 编写端到端集成测试
    - 测试完整用户旅程（首次使用 -> 设置画像 -> 识别食物 -> 查看历史）
    - _需求: 1.1, 1.2, 3.1, 4.1_

- [ ] 11. Checkpoint - 确保核心识别功能正常工作
  - 确保所有测试通过，如有问题请询问用户

- [x] 12. 订阅和配额管理
  - [x] 12.1 实现 SubscriptionManager 类
    - 实现配额检查逻辑
    - 实现使用次数增加
    - 实现升级提示
    - _需求: 7.1, 7.2, 7.8_
  
  - [x] 12.2 集成 Stripe
    - 配置 Stripe API
    - 创建订阅产品和价格
    - 实现订阅创建流程
    - 实现 Webhook 处理（订阅事件）
    - _需求: 7.3, 7.4, 7.5_
  
  - [ ]* 12.3 编写配额检查一致性的属性测试
    - **属性 7: 配额检查一致性**
    - **验证需求: 7.2**

- [x] 13. 数据持久化和历史记录
  - [x] 13.1 实现食物记录保存
    - 保存识别结果到 food_records 表
    - 上传图片到 Supabase Storage
    - 实现图片 URL 生成
    - _需求: 1.1, 1.2_
  
  - [x] 13.2 实现历史记录查询
    - 实现分页查询
    - 实现日期筛选
    - 实现搜索功能
    - _需求: 10.2, 10.10_
  
  - [ ]* 13.3 编写数据持久化完整性的属性测试
    - **属性 8: 数据持久化完整性**
    - **验证需求: 隐含需求 - 数据一致性**

- [x] 14. 错误处理和用户引导
  - [x] 14.1 实现 ErrorHandler 类
    - 实现错误分类逻辑
    - 实现多语言错误消息生成
    - 实现错误日志记录
    - 实现运维告警
    - _需求: 19.1, 19.2, 19.3, 19.6, 19.7_
  
  - [x] 14.2 实现 RetryManager 类
    - 实现指数退避重试策略
    - 实现可重试错误判断
    - _需求: 12.7_
  
  - [ ]* 14.3 编写错误处理友好性的属性测试
    - **属性 9: 错误处理友好性**
    - **验证需求: 1.5, 19.1, 19.2, 19.3**

- [ ] 15. Checkpoint - 确保错误处理和数据持久化正常工作
  - 确保所有测试通过，如有问题请询问用户

- [x] 16. 每日健康总结生成器
  - [x] 16.1 实现 DailyDigestGenerator 类
    - 实现数据汇总逻辑
    - 实现洞察生成
    - 实现建议生成
    - 实现运动建议计算
    - _需求: 6.2, 6.3, 6.4, 6.5_
  
  - [x] 16.2 实现 Cron Job
    - 创建 /api/cron/daily-digest 端点
    - 配置 Vercel Cron（每天 21:00 SGT）
    - 实现批量用户处理
    - _需求: 6.1, 6.8_
  
  - [ ]* 16.3 编写每日总结单元测试
    - 测试数据汇总正确性
    - 测试运动建议计算
    - _需求: 6.2, 6.5_

- [x] 17. 成本监控和优化
  - [x] 17.1 实现 CostOptimizer 类
    - 实现模型选择逻辑
    - 实现图片优化
    - 集成缓存检查
    - 记录 API 调用成本
    - _需求: 20.1, 20.3, 20.5_
  
  - [x] 17.2 实现 CostMonitor 类
    - 实现每日成本追踪
    - 实现异常用户检测
    - 实现预算告警
    - _需求: 20.2, 20.6, 20.7, 20.8_
  
  - [x] 17.3 创建监控仪表板
    - 显示 API 调用量、成本、错误率
    - 显示缓存命中率
    - _需求: 20.6_

- [x] 18. Web Dashboard 前端
  - [x] 18.1 实现认证流程
    - 创建登录页面
    - 实现 WhatsApp 登录链接发送
    - 实现 token 验证
    - _需求: 10.5_
  
  - [x] 18.2 实现 Dashboard 主页
    - 创建统计概览组件
    - 创建营养趋势图表
    - 创建食物历史列表
    - _需求: 10.2, 10.3, 10.4_
  
  - [x] 18.3 实现数据导出功能
    - 实现 CSV 导出
    - 实现 PDF 导出
    - _需求: 10.8_

- [x] 19. 多语言和本地化
  - [x] 19.1 实现 i18n 系统
    - 创建翻译文件（en、zh-CN、zh-TW）
    - 实现翻译函数
    - 实现语言切换
    - _需求: 15.1, 15.3, 15.4_
  
  - [x] 19.2 实现新加坡本地化
    - 创建新加坡食物名称映射
    - 实现货币格式化
    - 实现日期格式化
    - _需求: 15.5, 15.6_

- [x] 20. 安全和监控
  - [x] 20.1 实现安全措施
    - 实现 API 速率限制（每用户每分钟最多 10 次请求）
    - 实现 WhatsApp Webhook 签名验证
    - 实现 Stripe Webhook 签名验证
    - 实现数据加密工具类（AES-256-GCM）
    - _需求: 11.1, 11.7_
  
  - [x] 20.2 集成 Sentry
    - 配置 Sentry 错误追踪
    - 实现自定义指标追踪（API 调用、成本、缓存命中率）
    - 配置敏感信息过滤（手机号、token、密码）
    - 实现错误分组和告警规则
    - _需求: 12.4_
  
  - [x] 20.3 实现日志系统
    - 配置 Pino 日志库
    - 实现 PII 数据脱敏（手机号、邮箱）
    - 实现结构化日志（JSON 格式）
    - 实现日志级别管理
    - _需求: 12.4, 11.8_
  
  - [x] 20.4 实现异常登录检测
    - 记录用户登录日志
    - 检测异常登录模式
    - 通过 WhatsApp 发送安全通知
    - _需求: 11.9_

- [x] 21. 最终集成和测试
  - [x] 21.1 端到端测试
    - 测试完整用户流程（首次使用 -> 设置画像 -> 识别食物 -> 查看历史）
    - 测试支付流程（订阅创建 -> 支付 -> 功能解锁）
    - 测试每日总结生成（数据汇总 -> 洞察生成 -> WhatsApp 发送）
    - 测试多语言切换
    - _需求: 所有核心需求_
  
  - [x] 21.2 性能测试
    - 测试并发处理能力（模拟 100 个并发用户）
    - 测试响应时间（图片识别 < 10 秒）
    - 测试数据库查询性能（历史记录查询 < 1 秒）
    - 测试缓存命中率（目标 > 30%）
    - _需求: 12.1, 12.5_
  
  - [x] 21.3 安全审计
    - 检查 RLS 策略（用户只能访问自己的数据）
    - 检查 API 安全（速率限制、签名验证）
    - 检查数据加密（敏感数据加密存储）
    - 检查日志脱敏（PII 数据不出现在日志中）
    - _需求: 11.1, 11.2, 11.7, 11.8_
  
  - [x] 21.4 负载测试
    - 测试高峰时段处理能力
    - 测试数据库连接池
    - 测试 Redis 缓存性能
    - 测试 Vercel Functions 自动扩展
    - _需求: 12.5, 12.9_

- [x] 22. 部署和文档
  - [x] 22.1 部署到生产环境
    - 配置 Vercel 生产环境
    - 配置环境变量（使用 Vercel Environment Variables）
    - 配置自定义域名和 SSL 证书
    - 配置 Vercel Cron Jobs（每日总结）
    - 测试生产环境部署
    - _需求: 12.3_
  
  - [x] 22.2 编写部署文档
    - 记录部署步骤（Vercel + Supabase + Stripe）
    - 记录环境变量配置清单
    - 记录数据库迁移步骤
    - 记录 WhatsApp Business API 配置
    - 记录监控和告警配置
  
  - [x] 22.3 编写用户文档
    - 创建用户使用指南（如何开始、如何设置画像、如何查看历史）
    - 创建 FAQ（常见问题解答）
    - 创建隐私政策（符合 PDPA）
    - 创建服务条款
    - 创建订阅说明（Free/Premium/Pro 对比）
    - _需求: 11.6, 19.8_
  
  - [x] 22.4 编写运维文档
    - 记录监控指标和告警规则
    - 记录故障排查流程
    - 记录备份和恢复流程
    - 记录成本优化建议
    - 记录扩展计划

- [x] 22.5 配置备份和恢复机制
    - 配置 Supabase 自动备份
    - 实现数据导出脚本
    - 测试数据恢复流程
    - 配置备份告警
    - _需求: 隐含需求 - 数据安全_

- [x] 23. Checkpoint - 确保部署和文档完整
  - 确保生产环境正常运行
  - 确保所有文档完整且准确
  - 确保监控和告警正常工作

- [x] 24. Final Checkpoint - 确保所有功能正常工作
  - 确保所有测试通过，系统可以上线

## 第二阶段任务（留存与闭环）

以下任务为第二阶段计划，在 MVP 上线并验证后执行：

- [x] 25. 用户反馈系统
  - [x] 25.1 实现反馈收集
    - 在识别结果中添加"识别准确"和"识别错误"按钮
    - 实现 /feedback 命令
    - 保存反馈到数据库
    - _需求: 13.1, 13.2, 13.3, 13.4_
  
  - [x] 25.2 实现反馈分析
    - 实现月度反馈数据分析
    - 识别高频问题
    - 生成改进建议报告
    - _需求: 13.5_

- [x] 26. 社交和激励机制
  - [x] 26.1 实现连续打卡系统
    - 记录用户连续使用天数
    - 发送祝贺消息和健康徽章
    - _需求: 14.1, 14.2_
  
  - [x] 26.2 实现成就系统
    - 创建成就类型（识别 100 种食物、连续 30 天健康饮食等）
    - 实现成就解锁逻辑
    - 发送祝贺消息
    - _需求: 14.3, 14.4_
  
  - [x] 26.3 实现每周目标
    - 允许用户设置每周健康目标
    - 跟踪目标完成进度
    - 发送鼓励消息和进度总结
    - _需求: 14.5, 14.6_
  
  - [x] 26.4 实现排行榜（可选）
    - 创建匿名排行榜
    - 基于健康评分排名
    - 允许用户选择加入
    - _需求: 14.7_

- [x] 27. 智能上下文理解
  - [x] 27.1 实现用餐场景推断
    - 基于时间自动推断用餐场景
    - _需求: 16.1_
  
  - [x] 27.2 实现用户偏好学习
    - 记录用户常吃的食物
    - 在评价时考虑用户偏好
    - _需求: 16.2_
  
  - [x] 27.3 实现智能推荐
    - 基于历史偏好推荐食物
    - 基于营养缺口推荐食物
    - _需求: 16.3, 16.4_
  
  - [x] 27.4 实现位置推荐（可选）
    - 接收用户位置信息
    - 推荐附近的健康餐饮选择
    - _需求: 16.5_
  
  - [x] 27.5 实现饮食模式学习
    - 学习用户的饮食模式
    - 在异常时提醒用户
    - _需求: 16.6_

- [x] 28. 离线和网络优化
  - [x] 28.1 实现图片压缩和重试
    - 网络不稳定时自动压缩图片
    - 上传失败时自动重试
    - 通知用户当前状态
    - _需求: 18.1, 18.2_
  
  - [x] 28.2 实现本地缓存
    - 缓存用户健康画像
    - 缓存常见食物数据
    - _需求: 18.3_
  
  - [x] 28.3 实现渐进式加载
    - 优先显示关键信息
    - 优先从缓存加载
    - _需求: 18.4, 18.5_
  
  - [x] 28.4 实现离线提示
    - 检测网络状态
    - 提示用户稍后会处理图片
    - _需求: 18.6_

## 第三阶段任务（高阶差异化）

以下任务为第三阶段计划，在第二阶段完成并验证后执行：

- [ ] 29. 体检报告数字化
  - [ ] 29.1 实现 OCR 提取
    - 使用多模态 AI API 提取健康指标
    - 识别新加坡常见体检报告格式
    - _需求: 8.1, 8.2, 8.3_
  
  - [ ] 29.2 实现报告解读
    - 将医学指标转化为通俗易懂的建议
    - 提供针对性的饮食调整建议
    - 检测严重异常并建议咨询医生
    - _需求: 8.4, 8.5, 8.6_
  
  - [ ] 29.3 实现历史对比
    - 安全存储体检报告数据
    - 支持历史对比
    - 结合历史饮食数据提供建议
    - _需求: 8.7, 8.8_

- [ ] 30. 超市扫描助手
  - [ ] 30.1 实现营养标签识别
    - 识别并提取营养信息
    - 支持新加坡主流超市标签格式
    - _需求: 9.1, 9.4_
  
  - [ ] 30.2 实现购买建议
    - 基于用户健康目标给出建议
    - 使用三级评价（推荐购买/偶尔尝试/不推荐）
    - 推荐更健康的替代品
    - _需求: 9.2, 9.3, 9.5, 9.6_
  
  - [ ] 30.3 实现条形码扫描
    - 支持扫描条形码快速查询
    - 提供营养对比功能
    - _需求: 9.7, 9.8_

## 注意事项

- 标记 `*` 的任务为可选测试任务，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求编号，便于追溯
- Checkpoint 任务确保增量验证，及时发现问题
- 属性测试任务明确标注了对应的设计文档属性编号
- 所有代码使用 TypeScript 编写
- 第二阶段和第三阶段任务在 MVP 验证后再执行

## 任务执行优先级

### 高优先级（必须完成）
- 任务 1-19: 核心功能实现
- 任务 20: 安全和监控
- 任务 21: 最终集成和测试
- 任务 22: 部署和文档

### 中优先级（建议完成）
- 所有非标记 `*` 的测试任务
- Checkpoint 任务

### 低优先级（可选）
- 标记 `*` 的测试任务
- 第二阶段和第三阶段任务
